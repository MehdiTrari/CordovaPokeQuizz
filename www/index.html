<!doctype html>
<html>
<script type="text/javascript" src="cordova.js"></script>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data: blob: https:;
                 connect-src 'self' https://tyradex.app https://tyradex.vercel.app;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-eval' 'unsafe-inline';">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PokeQuiz</title>
  <style>
    :root{
      --transition:.25s ease; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.25);
      --bg1:#0f172a; --bg2:#1e293b; --card:#0b1226aa; --border:#33415599;
      --text:#e5e7eb; --muted:#94a3b8; --primary:#22d3ee; --primary-2:#60a5fa;
      --success:#22c55e; --error:#ef4444; --btnText:#0b1226; --btnTextHover:#0ea5e9;
    }
    :root[data-theme="light"]{
      --bg1:#f7fafc; --bg2:#eef2f7; --card:#ffffffd8; --border:#e2e8f0cc;
      --text:#0f172a; --muted:#475569; --primary:#0ea5e9; --primary-2:#60a5fa;
      --success:#16a34a; --error:#dc2626; --btnText:#083344; --btnTextHover:#075985;
      --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(14,165,233,.25) 0%, transparent 45%),
        radial-gradient(900px 500px at 120% 10%, rgba(34,211,238,.25) 0%, transparent 40%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background var(--transition), color var(--transition);
    }
    .topbar{position:sticky; top:0; z-index:10; display:flex; gap:.5rem; padding:.6rem .8rem;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(11,18,38,.75), rgba(11,18,38,.45)); backdrop-filter: blur(10px);}
    :root[data-theme="light"] .topbar{background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6));}
    .topbar button{padding:.55rem 1rem; border-radius:999px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text); cursor:pointer;
      transition:transform .12s ease, background var(--transition), border-color var(--transition), color var(--transition);}
    .topbar button:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .topbar button.is-active{border-color:transparent; background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:var(--btnText); font-weight:700;}
    main#app{max-width:900px; margin:32px auto; padding:0 16px}
    .route{display:none} .route.active{display:block}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:22px; backdrop-filter: blur(8px); animation:fadeIn .25s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
    h1,h2{margin:0 0 10px 0; letter-spacing:.3px; color:#000;} /* titres en noir */
    h1{font-size:clamp(28px,3vw,36px)} h2{font-size:clamp(22px,2.2vw,28px)}
    p{color:var(--muted); margin:8px 0 16px 0}
    #quizCard,#finalCard{display:flex; flex-direction:column; gap:16px}
    .poke-img-wrapper{display:flex; justify-content:center; align-items:center; height:260px; border-radius:calc(var(--radius)-6px);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px dashed var(--border);
      box-shadow:inset 0 1px 6px rgba(0,0,0,.15); overflow:hidden}
    :root[data-theme="light"] .poke-img-wrapper{background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.02)); box-shadow:inset 0 1px 6px rgba(0,0,0,.05)}
    #pokeImg{max-height:100%; max-width:100%; filter:grayscale(1) contrast(1.08) brightness(.98) drop-shadow(0 15px 25px rgba(0,0,0,.35)); transition:filter var(--transition)}
    form{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap}
    input[type="text"]{flex:1 1 220px; font-size:1rem; padding:.8rem 1rem; color:var(--text); background:#0b1226;
      border:1px solid var(--border); border-radius:12px; outline:none;
      transition:border-color var(--transition), box-shadow var(--transition), background var(--transition), color var(--transition)}
    :root[data-theme="light"] input[type="text"]{background:#fff}
    input[type="text"]::placeholder{color:#94a3b87a}
    input[type="text"]:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(34,211,238,.2)}
    button{font-size:1rem; padding:.8rem 1.05rem; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--text); cursor:pointer;
      transition:transform .12s ease, background var(--transition), border-color var(--transition), color var(--transition)}
    button:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .btn-primary{border-color:transparent; background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:var(--btnText); font-weight:700}
    .btn-primary:hover{color:var(--btnTextHover); filter:saturate(1.05)}
    #feedback{min-height:1.25rem; font-weight:700; letter-spacing:.2px}
    #feedback.ok{color:var(--success)} #feedback.ko{color:var(--error)}
    .progressbar{width:100%; height:10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); overflow:hidden}
    :root[data-theme="light"] .progressbar{background:#f1f5f9}
    .progressbar>div{height:100%; width:0%; background:linear-gradient(90deg, var(--primary), var(--primary-2)); transition:width .3s ease}
    #leaderList{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px}
    #leaderList li{display:flex; align-items:center; gap:10px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:12px; padding:10px 12px}
    :root[data-theme="light"] #leaderList li{background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015))}
    #leaderList li::before{content:"üèÜ"; opacity:.9; font-size:18px}
    .stack{display:grid; gap:16px} .mt-3{margin-top:1rem}
  </style>
</head>
<body>
  <nav class="topbar">
    <button data-link="#/" class="is-active">Accueil</button>
    <button data-link="#/quiz">Quiz</button>
    <button data-link="#/leaderboard">Classement</button>
    <div style="margin-left:auto"></div>
    <button id="themeToggle" title="Basculer th√®me">üåô</button>
  </nav>

  <main id="app" class="stack">
    <section data-route="/" class="route active">
      <div class="card">
        <h1>PokeQuiz</h1>
        <p>Devine le Pok√©mon (10 questions). Sauvegarde ton score et ton temps !</p>
        <button id="startBtn" class="btn-primary">Commencer</button>
      </div>
    </section>

    <section data-route="/quiz" class="route">
      <div class="card" id="quizCard">
        <div class="poke-img-wrapper">
          <img id="pokeImg" src="" alt="Pok√©mon myst√®re" />
        </div>
        <div class="progressbar"><div id="pb"></div></div>
        <form id="answerForm">
          <input id="answerInput" type="text" placeholder="Nom du Pok√©mon" autocomplete="off" />
          <button type="submit" class="btn-primary">Valider</button>
        </form>
        <p id="feedback"></p>
        <p id="progress">Question <span id="qIndex">0</span>/10 ‚Äî Score : <span id="score">0</span></p>
      </div>

      <div class="card hidden" id="finalCard">
        <h2>R√©sultat : <span id="finalScore"></span>/10</h2>
        <p>Temps : <span id="finalTime"></span></p>
        <form id="saveForm">
          <input id="playerName" type="text" placeholder="Ton nom" required />
          <button type="submit" class="btn-primary">Sauvegarder</button>
        </form>
        <button id="retryBtn">Rejouer</button>
      </div>
    </section>

    <section data-route="/leaderboard" class="route">
      <div class="card">
        <h2>Top 5</h2>
        <ol id="leaderList" class="mt-3"></ol>
        <button id="refreshBoard" class="mt-3">Rafra√Æchir</button>
      </div>
    </section>
  </main>

  <script>
    /* ===== Theme bootstrap ===== */
    function preferredTheme(){ const s=localStorage.getItem('theme'); if(s) return s;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
    function applyTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t);
      const btn=document.getElementById('themeToggle'); if(btn) btn.textContent=(t==='dark')?'üåô':'‚òÄÔ∏è'; }
    (function(){ applyTheme(preferredTheme()); })();

    /* ===== Helper vibration (plugin ou fallback navigateur) ===== */
    function vibrate(pattern){
      try{
        if (window.VibrationAdv && typeof VibrationAdv.vibratePattern === 'function'){
          VibrationAdv.vibratePattern(pattern, ()=>{}, ()=>{});
          return;
        }
      }catch(e){}
      if (navigator.vibrate) navigator.vibrate(pattern); // fallback web
    }

    /* ---------- Router + active button state ---------- */
    function setActiveBtn(hash){
      document.querySelectorAll('.topbar button[data-link]').forEach(b=>b.classList.remove('is-active'));
      const btn = document.querySelector(`.topbar button[data-link="${hash}"]`);
      if (btn) btn.classList.add('is-active');
    }
    function render(current = window.location.hash || '#/') {
      const route = current.replace('#','');
      document.querySelectorAll('.route').forEach(s => s.classList.remove('active'));
      (document.querySelector('[data-route="'+route+'"]') || document.querySelector('[data-route="/"]')).classList.add('active');
      setActiveBtn('#'+route);
      if (route === '/leaderboard') renderLeaderboard();
      if (route === '/quiz') resetQuizUI();
    }
    function navigate(hash){ window.location.hash = hash; render(hash); }

    /* ---------- Utils ---------- */
    const API_BASE='https://tyradex.app/api/v1/pokemon';
    const QUESTIONS=10, MAX_ID=1025;
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    function normalizeName(s=''){ return s.toString().trim().toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9\- ]/g,' ').replace(/\s+/g,' '); }
    const fmtTime=s=>`${Math.floor(s/60)}m${String(s%60).padStart(2,'0')}s`;

    /* ---------- Storage ---------- */
    const FILE_NAME='scores.json'; let fsDir=null;
    function hasCordovaFS(){ return !!(window.cordova && window.resolveLocalFileSystemURL && window.cordova.file && cordova.file.dataDirectory); }
    async function ensureDir(){ if(!hasCordovaFS()) throw new Error('no-file'); return new Promise((res,rej)=>{
      if (fsDir) return res(fsDir); window.resolveLocalFileSystemURL(cordova.file.dataDirectory, e=>{fsDir=e;res(e);}, rej); }); }
    async function readScores(){ if(hasCordovaFS()){ try{
      const dir=await ensureDir(); return await new Promise((resolve,reject)=>{
        dir.getFile(FILE_NAME,{create:true},fe=>{ fe.file(file=>{ const r=new FileReader();
          r.onloadend=()=>{ try{ resolve(r.result?JSON.parse(r.result):[]);}catch{resolve([]);} }; r.readAsText(file); },reject); },reject); }); }catch{} }
      return JSON.parse(localStorage.getItem('scores')||'[]'); }
    async function writeScores(arr){ if(hasCordovaFS()){ try{
      const dir=await ensureDir(); return await new Promise((resolve,reject)=>{
        dir.getFile(FILE_NAME,{create:true},fe=>{ fe.createWriter(w=>{ w.onwriteend=resolve; w.onerror=reject;
          const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'}); w.truncate(0); setTimeout(()=>w.write(blob),10); },reject); },reject); }); }catch{} }
      localStorage.setItem('scores', JSON.stringify(arr)); }
    async function pushScore(rec){ const arr=await readScores(); arr.push(rec);
      arr.sort((a,b)=> b.score-a.score || a.timeSec-b.timeSec || (a.date||'').localeCompare(b.date||'')); await writeScores(arr); return arr; }
    async function topN(n=5){ const arr=await readScores(); arr.sort((a,b)=> b.score-a.score || a.timeSec-b.timeSec); return arr.slice(0,n); }

    /* ---------- Quiz state ---------- */
    const state={ index:0, score:0, startTs:0, current:null };
    async function fetchPokemon(id){
      const res = await fetch(`${API_BASE}/${id}`); if(!res.ok) throw new Error('API '+res.status);
      const data = await res.json();
      const name = (data?.name?.fr) || (data?.name?.en) || data?.name || '';
      const imageUrl = data?.sprites?.regular || data?.sprites?.default || data?.image || '';
      return { id, name, imageUrl };
    }
    function updateProgress(){ const pct=Math.min(100, Math.max(0,(state.index/QUESTIONS)*100));
      const el=document.getElementById('pb'); if(el) el.style.width=pct+'%';
      document.getElementById('qIndex').textContent=String(Math.min(state.index, QUESTIONS)); }

    async function nextQuestion(){
      if (state.index >= QUESTIONS) return showFinal();
      const fbEl=document.getElementById('feedback'); fbEl.className=''; fbEl.textContent='';
      document.getElementById('answerInput').value=''; document.getElementById('qIndex').textContent=String(state.index+1);
      let poke=null; for(let tries=0; tries<5 && !poke; tries++){ try{ const p=await fetchPokemon(randInt(1,MAX_ID)); if(p.imageUrl) poke=p; }catch{} }
      if(!poke){ fbEl.textContent="Erreur de chargement. R√©essaie."; return; }
      state.current=poke; const img=document.getElementById('pokeImg');
      img.style.filter='grayscale(1) contrast(1.08) brightness(.98) drop-shadow(0 15px 25px rgba(0,0,0,.35))';
      img.src=poke.imageUrl; updateProgress();
    }

    function onSubmitAnswer(e){
      e.preventDefault(); if(!state.current) return;
      const guess=normalizeName(document.getElementById('answerInput').value);
      const correct=normalizeName(state.current.name);
      const ok = guess && correct && (guess===correct);
      const fb=document.getElementById('feedback');

      if (ok){
        state.score++; fb.textContent=`‚úÖ Bravo ! C'√©tait ${state.current.name}.`; fb.className='ok';
        document.getElementById('pokeImg').style.filter='grayscale(0) contrast(1) drop-shadow(0 15px 25px rgba(0,0,0,.35))';
        vibrate([200]);                        // ‚úÖ bonne r√©ponse : 1 vibration
      } else {
        fb.textContent=`‚ùå Rat√©. C'√©tait ${state.current.name}.`; fb.className='ko';
        vibrate([200,100,200]);               // ‚ùå mauvaise : 2 vibrations
      }
      document.getElementById('score').textContent=String(state.score);
      state.index++; updateProgress(); setTimeout(nextQuestion,800);
    }

    function showFinal(){
      const elapsedSec=Math.round((Date.now()-state.startTs)/1000);
      document.getElementById('finalScore').textContent=String(state.score);
      document.getElementById('finalTime').textContent=fmtTime(elapsedSec);
      document.getElementById('quizCard').classList.add('hidden');
      document.getElementById('finalCard').classList.remove('hidden');
      vibrate([200,100,200,100,200]);         // üéâ fin de jeu : 3 vibrations
      document.getElementById('saveForm').onsubmit=async(e)=>{
        e.preventDefault();
        const player=(document.getElementById('playerName').value||'Anon').trim();
        await pushScore({ player, score:state.score, timeSec:elapsedSec, date:new Date().toISOString() });
        navigate('#/leaderboard');
      };
    }

    function resetQuizUI(){
      document.getElementById('finalCard').classList.add('hidden');
      document.getElementById('quizCard').classList.remove('hidden');
      const fb=document.getElementById('feedback'); fb.textContent=''; fb.className='';
      document.getElementById('answerInput').value=''; document.getElementById('playerName').value='';
      document.getElementById('score').textContent='0'; document.getElementById('qIndex').textContent='0';
      const pb=document.getElementById('pb'); if(pb) pb.style.width='0%';
      document.getElementById('finalScore').textContent='0'; document.getElementById('finalTime').textContent='0m00s';
    }
    function resetQuiz(){ state.index=0; state.score=0; state.startTs=Date.now(); state.current=null; resetQuizUI(); nextQuestion(); }

    async function renderLeaderboard(){
      const list=document.getElementById('leaderList'); list.innerHTML='';
      const top=await topN(5);
      if(top.length===0){ list.innerHTML='<li>Aucun score pour le moment.</li>'; return; }
      top.forEach((r,i)=>{ const li=document.createElement('li'); li.textContent=`${i+1}. ${r.player} ‚Äî ${r.score}/10 ‚Äî ${r.timeSec}s`; list.appendChild(li); });
    }

    /* ---------- Bootstrap ---------- */
    function onReady(){
      window.addEventListener('hashchange', ()=>render()); render();
      document.querySelectorAll('nav [data-link]').forEach(b=>{ b.addEventListener('click', ()=>navigate(b.getAttribute('data-link'))); });
      const themeBtn=document.getElementById('themeToggle');
      if(themeBtn){ themeBtn.addEventListener('click', ()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; applyTheme(cur==='dark'?'light':'dark'); }); }
      document.getElementById('startBtn').addEventListener('click', ()=>{ navigate('#/quiz'); resetQuiz(); });
      document.getElementById('answerForm').addEventListener('submit', onSubmitAnswer);
      document.getElementById('retryBtn').addEventListener('click', ()=>{ navigate('#/quiz'); resetQuiz(); });
      document.getElementById('refreshBoard').addEventListener('click', renderLeaderboard);
    }
    document.addEventListener('deviceready', onReady, false);
    if (document.readyState === 'complete') onReady(); else window.addEventListener('load', onReady);
  </script>
</body>
</html>
